<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE =edge">
    <meta name="viewport" content="width =device-width, initial-scale=1.0">
    <title>Notes</title>
    <style> 
        body
        {
            background-color: black;
            color: white;
            font-family: "Courier New";
            font-size: large;
        }
        input
        {
            width: 100%;
            background-color: black;
            color: white;
            font-family: "Courier New";
            border: none;
            outline: none;
            font-size: large;
        }
    </style>
</head>
<body>
    <input type="text" id="tb" autocapitalize="none" />
    <hr />
    <div id="dv"> </div>
</body>
<script>
    var data = [];

    window.addEventListener("load", () => { loadData(); showToday(); });

    document.addEventListener("click", (event) => document.getElementById("tb").focus());

    document.getElementById("tb").addEventListener("keyup", (event) => { if (event.keyCode == 13) processData(document.getElementById("tb").value); } );

    processData = (text) => {
        if (!text) {
            return
        }

        document.getElementById("tb").value = "";
        let all = text.split(" ");
        let action = all[0];
        let content = text.substring(action.length);
        switch (action) {
            case "add": {
                doAdd(content);
                break;
            }
            case "list": {
                doList();
                break;
            }
            case "filter": {
                doFilter(content);
                break;
            }
            case "clear": {
                doClear();
                break;
            }
            case "reset": {
                doReset();
                break;
            }
        }
    }

    doAdd = (text) => {
        if (!text) {
            return
        }
        
        let pattern = /#\S+/g;
        let defaultTag = "#note";
        let tags = text.match(pattern);
        if ((tags || []).filter(t => t.length > 0) == 0) {
            tags = [defaultTag];
            text = `${text} ${defaultTag}`;
        }
        data.push({
            date: new Date(),
            tags: tags,
            text: text
        });
        saveData();
        showToday();
    }

    doList = () => {
        showList(data);
    }

    doFilter = (content) => {
        if (!content) {
            return
        }
        
        let filters = content.split("+");
        let subData = data.map(d => d);
        filters.forEach(f => {
            let field = f.split(":")[0].trim();
            let condition = f.split(":")[1].trim();
            switch (field) {
                case "date": {
                    let from = new Date(condition.split("-")[0]);
                    let to = new Date(condition.split("-")[1]);
                    subData = subData.filter(s => new Date(isoToString(s.date)) >= from && new Date(isoToString(s.date)) <= to);
                    break;
                }
                case "tag": {
                    subData = subData.filter(s => s.tags.includes(`#${condition}`));
                    break;
                }
                case "text": {
                    subData = subData.filter(s => s.text.indexOf(condition) > -1);
                    break;
                }
            }
        });

        showList(subData);
    }

    doReset = () => {
        data = [];
        saveData();
        showData("");
    }

    doClear = () => showData("");

    showToday = () => doFilter(`date:${isoToString(new Date())}-${isoToString(new Date())}`);

    showList = (list) => {
        list.sort((a, b) => new Date(b.date) - new Date(a.date));
        let message = "";
        let currDate;
        list.forEach(l => {
            if (currDate != isoToString(l.date)) {
                message = `${message}[${isoToString(l.date)}]\n\n`;
                currDate = isoToString(l.date);
            }
            message = `${message}${l.text}\n\n`;
        });
        showData(message);
    }

    showData = (text, append) => document.getElementById("dv").innerText = `${text}\n${append ? document.getElementById("dv").innerText : ""}`;

    saveData = () => localStorage.setItem("command", JSON.stringify(data));

    loadData = () => data = JSON.parse(localStorage.getItem("command") || "[]");

    isoToString = (date) => {
        date = new Date(date);
        return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
    }
</script>
</html>
